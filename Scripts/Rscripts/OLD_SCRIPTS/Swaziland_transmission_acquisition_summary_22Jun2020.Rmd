---
title: "Transmission dynamics in the era of test and treat" 
author: "Adam Akullian"
date: "`r Sys.Date()`"
output: 
  html_document:
    df_print: paged
    highlight: tango
    toc: true
    toc_float: true
    theme: united
    fig_width: 7
    fig_height: 4
    fig_caption: true
    code_folding: hide
---
## Project description
HIV transmission in the era of test and treat: A mathematical modelling study. We used output from a stochastic agent-based epidemic model calibrated to the HIV epidemic in the Kingdom of Eswatini (formerly Swaziland) to estimate the number and relative frequency of secondary infections caused by HIV infected individuals according to age group, sex, stage of infection (acute, early, latent, AIDS), and ART status. We estimated changes in the contribution of these sources to the epidemic over the previous and next thirty years, under multiple ART-defined scenarios (e.g. pre-ART, ART, ART scale up, status-quo ART coverage (current 90-90-90 targets), and increasing levels of UTT near-perfect ART initiation
Documentation on all model parameters: https://idmod.org/docs/hiv/software-report-transmission.html?searchText=TransmissionReport

## Setup
```{r setup, message = FALSE}
require("knitr")
knitr::opts_chunk$set(echo = TRUE, fig.align='center')
opts_knit$set(root.dir = "C:\\Users\\aakullian\\Dropbox (IDM)\\GitHub\\EMOD_eswatini\\Output\\")

library(kableExtra)
library(tidyverse)
library(janitor)
library(lubridate)
library(survival)
library(MASS)
library(glmnet)
library(parallel)
library(survivalROC)
library(Hmisc)
library(data.table)

numCores <- detectCores()

## Load helper functions
#source("../Scripts/model_helper_functions.R")

## Load output from EMOD
setwd("C:\\Users\\aakullian\\Dropbox (IDM)\\GitHub\\EMOD_eswatini\\Output")
load(file = "inputfiles.rda") #brings in transmissionreport.csv and reporthivbyageandgender.csv

length(unique(transmissionreport$SRC_ID[transmissionreport$sim.id=="f3e9b78a-3c6a-ea11-a2c5-c4346bcb1550"])) #number of unique sources
length(unique(transmissionreport$DEST_ID[transmissionreport$sim.id=="f3e9b78a-3c6a-ea11-a2c5-c4346bcb1550"])) #number of unique destinations

#create "date of acquisition" variable as date when the dest_ID acquired HIV (whether or not there was a subsequent transmission)
date.of.acquisition <- data.frame("SRC_ID"=transmissionreport$DEST_ID, "acq.year"=transmissionreport$Year2, "sim.id"=transmissionreport$sim.id, "scenario"=transmissionreport$scenario) #source id used to merge in with source of transmitters
network.data <- left_join(transmissionreport, date.of.acquisition, by=c("SRC_ID","sim.id","scenario")) #join to include date of acquisition

names(network.data)

network.data.m <- network.data %>%    
  mutate(src.age.25 = cut(src.age.int, c(15,25,200), right=F)) %>%
  mutate(src.age.cat3 = cut(src.age.int, c(15,25,35,200), right=F)) %>%
  mutate(dest.age.cat3 = cut(dest.age.int, c(15,25,35,200), right=F)) %>%
  mutate(acq.age=floor(src.age.int-(transm.year.int-acq.year))) %>% #age of source when they acquired HIV
  mutate(acq.age.cat = cut(acq.age, c(15,20,25,30,35,40,45,200), right=F)) %>%
  mutate(transm.year.cat = cut(transm.year.int, c(1990,2004,2016,2030,2050), right=F, dig.lab=4)) %>%
  mutate(acq.year.cat = cut(acq.year, c(1990,2004,2016,2030,2050), right=F, dig.lab=4)) %>%
  mutate(TimeToTransmission = transm.year.int - acq.year) %>%
  mutate(era = case_when(transm.year.int < 2016 ~ "Pre-UTT", TRUE ~ "UTT era")) %>%
  mutate(src.stage.f = factor(src.stage, levels = c(1,2,3,4), labels = c("Acute","Latent","AIDS","on ART"))) %>%
  dplyr::select(-c(src.stage)) 
names(network.data.m)
summary(network.data.m)

names(transmissionreport)
transmissionreport$age.at.acquisition.cat <- cut(transmissionreport$dest_age_int, c(15,25,35,200), right=F)
transmissionreport$age.at.transmission.cat <- cut(transmissionreport$src_age_int, c(15,25,35,200), right=F)
transmissionreport$age.at.acquisition.cat5 <- cut(transmissionreport$dest_age_int, c(15,20,25,30,35,40,45,200), right=F)
transmissionreport$age.at.transmission.cat5 <- cut(transmissionreport$src_age_int, c(15,20,25,30,35,40,45,200), right=F)
transmissionreport$AgeCat <- cut(transmissionreport$dest_age_int, c(15,20,25,30,35,40,45,50,55,60,200), right=F)
transmissionreport$yearcat3 <- cut(transmissionreport$Year2, c(1980,1990,2004,2016,2030,2050), right=F, dig.lab=4)






network.data <- data.table("sim.id"=network.data$sim.id, "src_id"=network.data$SRC_ID, "dest_id"=network.data$DEST_ID, 
                           "src.gender"=network.data$SRC_GENDER, 
                           "dest.gender"=network.data$DEST_GENDER, 
                           "dest.age.cat"=network.data$age.at.acquisition.cat5, 
                           "src.age.cat"=network.data$age.at.transmission.cat5,
                           "dest.age.int"=network.data$dest_age_int, 
                           "src.age.int"=network.data$src_age_int,
                           "transm.year.int"=floor(network.data$Year2),
                           "acq.year"=network.data$acq.year,
                           "transm.year.cat"=network.data$yearcat3,
                           "src.stage"=network.data$SRC_STAGE,
                           "scenario"=network.data$scenario)

nrow(network.data[is.na(network.data$acq.year)==T & network.data$sim.id=="005a9663-9a43-ea11-a2c3-c4346bcb1551",]) #number of individuals with infection seeded in (from one sim).These individuals have acq.year recorded as NA 
length(unique(network.data$src_id[network.data$sim.id=="005a9663-9a43-ea11-a2c3-c4346bcb1551"])) #number of unique sources
length(unique(network.data$dest_id[network.data$sim.id=="005a9663-9a43-ea11-a2c3-c4346bcb1551"])) #number of unique destinations

```

```{r, echo = FALSE}
var_guide_baseline <- data.frame(
  var_name = c(names(network.data.m)),
  descr = c(
    "Simulation ID (N=250)",
    "Source transmission ID",
    "Destination transmission ID",
    "Source sex (0 = Male, 1 = Female)",
    "Destiation sex (0 = Male, 1 = Female)",
    "Age category of destination",
    "Age category of source",
    "Age integer of destination",
    "Age integer of source",
    "Year transmisison ocurred (integer 1980-2049)",
    "Year transmitter (dest) acquired HIV",
    "Year transmission occured (category)",
    "Model scenario (baseline=status quo ART, ART100pct=All HIV+ initiate ART within ~ 6 mo, viral load suppression within 1 year of acquisition",
    "Age when transmitter acquired HIV",
    "Year category when transmitter acquired HIV",
    "Age category when transmitter acquired HIV",
    "Age over/under 25",
    "Source age category (15-24, 25-34, and 35+)",
    "Destination age category (15-24, 25-34, and 35+)",
    "Time (years) from HIV acquisition to transmission (from source persepctive)",
    "era (pre/post UTT)",
    "Source HIV stage (Acute = untreated acute stage (2.9 months), Latent=untreated latent HIV (>3 months), AIDS=untreated AIDS, on ART=On ART"
  )
)

kable(
  var_guide_baseline,
  col.names = c("Variable name",
    "Description")
) %>% 
  kable_styling()
```

## Stepwise AIC models
Brings in reporthivbyageandgender.csv. This file defines the population at risk, new infections, and prevalent infections at each time step by strata.

```{r}
reporthivbyageandgender <- reporthivbyageandgender %>% 
  mutate(src.gender = Gender) %>%
  mutate(year = Year2) %>%
  mutate(NeverOnART = case_when(IP_Key.ARTstate == "NeverOnART" ~ 1, TRUE ~ 0)) %>%
  mutate(dest.age.cat = cut(reporthivbyageandgender$Age, c(15,20,25,30,35,40,45,50,55,60,200), right=F)) %>%
  dplyr::select(-c(Year2)) 

table(reporthivbyageandgender$NeverOnART, reporthivbyageandgender$IP_Key.ARTstate)
names(reporthivbyageandgender)

var_guide_reporthiv <- data.frame(
  var_name = c(names(reporthivbyageandgender)),
  descr = c(
    "Simulation ID (N=250)",
    "Source transmission ID",
    "Destination transmission ID",
    "Source sex (0 = Male, 1 = Female)",
    "Destiation sex (0 = Male, 1 = Female)",
    "Age category of destination",
    "Age category of source",
    "Age integer of destination",
    "Age integer of source",
    "Year transmisison ocurred (integer 1980-2049)",
    "Year transmitter (dest) acquired HIV",
    "Year transmission occured (category)",
    "Model scenario (baseline=status quo ART, ART100pct=All HIV+ initiate ART within ~ 6 mo, viral load suppression within 1 year of acquisition",
    "Age when transmitter acquired HIV",
    "Year category when transmitter acquired HIV",
    "Age category when transmitter acquired HIV",
    "Age over/under 25",
    "Source age category (15-24, 25-34, and 35+)",
    "Destination age category (15-24, 25-34, and 35+)",
    "Time (years) from HIV acquisition to transmission (from source persepctive)",
    "era (pre/post UTT)",
    "Source HIV stage (Acute = untreated acute stage (2.9 months), Latent=untreated latent HIV (>3 months), AIDS=untreated AIDS, on ART=On ART"
  )
)

kable(
  var_guide_baseline,
  col.names = c("Variable name",
    "Description")
) %>% 
  kable_styling()
```

